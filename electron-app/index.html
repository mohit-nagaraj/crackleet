<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LeetCode Helper</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
      background-color: rgba(0, 0, 0, 0.2);
      color: white;
      user-select: none;
      cursor: default;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #dragRegion {
      -webkit-app-region: drag;
      background-color: rgba(20, 20, 20, 0.8);
      padding: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .tab {
      padding: 5px 10px;
      cursor: pointer;
      background-color: rgba(40, 40, 40, 0.5);
      border-radius: 4px;
      -webkit-app-region: no-drag;
    }
    
    .tab.active {
      background-color: rgba(60, 60, 60, 0.8);
    }
    
    #mainContent {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      overflow: hidden;
    }
    
    #welcomeScreen, #settingsScreen, #analysisScreen {
      padding: 20px;
      background-color: rgba(40, 44, 52, 0.8);
      border-radius: 8px;
      margin: 10px;
      flex-grow: 1;
      overflow: auto;
      display: none;
    }

    #welcomeScreen {
      display: block;
    }
    
    #screenshotPreview {
      max-width: 100%;
      max-height: 200px;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      display: none;
    }
    
    .splitView {
      display: flex;
      flex-grow: 1;
      overflow: hidden;
    }
    
    .leftPanel, .rightPanel {
      flex: 1;
      padding: 10px;
      overflow: auto;
    }
    
    .leftPanel {
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    pre {
      margin: 0;
      padding: 15px;
      border-radius: 5px;
      background-color: rgba(30, 30, 30, 0.9);
      overflow: auto;
    }
    
    code {
      font-family: 'Consolas', 'Monaco', monospace;
    }
    
    #statusBar {
      background-color: rgba(30, 30, 30, 0.9);
      padding: 5px 10px;
      display: flex;
      justify-content: space-between;
    }
    
    .setting-group {
      margin-bottom: 20px;
    }
    
    input, select, button {
      background-color: rgba(60, 60, 60, 0.8);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      padding: 8px 12px;
      margin: 5px 0;
    }
    
    button {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: rgba(80, 80, 80, 0.8);
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
    }
    
    .loading::after {
      content: "";
      width: 40px;
      height: 40px;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-top: 5px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .note {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
    
    #complexityInfo {
      background-color: rgba(40, 40, 40, 0.8);
      padding: 10px;
      border-radius: 5px;
      margin-top: 15px;
      font-size: 14px;
    }
    
    #explanationText h3 {
      color: #61afef;
      margin-top: 15px;
      margin-bottom: 5px;
    }
    
    #explanationText ul {
      padding-left: 20px;
    }
    
    #explanationText li {
      margin-bottom: 5px;
    }
    
    .copy-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 4px 8px;
      font-size: 12px;
      background-color: rgba(80, 80, 80, 0.7);
    }
    
    .code-container {
      position: relative;
    }
    
    /* Make interactive regions more obvious */
    .interactive {
      position: relative;
      cursor: pointer !important;
    }
    
    .interactive:hover {
      box-shadow: 0 0 8px rgba(97, 175, 239, 0.8);
      outline: 1px solid rgba(97, 175, 239, 0.5);
    }
    
    /* Area for toggling mouse interaction without having elements */
    #interactionToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: rgba(97, 175, 239, 0.3);
      cursor: pointer;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      opacity: 0.5;
      transition: opacity 0.3s;
    }
    
    #interactionToggle:hover {
      opacity: 1;
    }
    
    .mouse-active {
      background-color: rgba(20, 250, 120, 0.3) !important;
    }
    
    /* Highlight when interaction is enabled */
    body.interaction-enabled {
      box-shadow: inset 0 0 10px rgba(97, 175, 239, 0.5);
    }
  </style>
</head>
<body>
  <!-- Mouse toggle button -->
  <div id="interactionToggle" title="Toggle mouse interaction">M</div>
  
  <div id="dragRegion">
    <div>LeetCode Helper</div>
    <div class="nav-buttons">
      <div class="tab interactive active" data-screen="welcomeScreen">Home</div>
      <div class="tab interactive" data-screen="analysisScreen">Analysis</div>
      <div class="tab interactive" data-screen="settingsScreen">Settings</div>
    </div>
  </div>
  
  <div id="mainContent">
    <!-- Welcome Screen -->
    <div id="welcomeScreen">
      <h1>LeetCode Interview Helper</h1>
      
      <div class="setting-group">
        <h2>Quick Start</h2>
        <button id="captureScreenshotBtn" class="interactive">Capture Screenshot</button>
      </div>
      
      <div class="note">
        <h3>Hotkeys:</h3>
        <ul>
          <li><strong>Ctrl+Alt+H:</strong> Toggle visibility</li>
          <li><strong>Ctrl+Alt+S:</strong> Capture screenshot</li>
          <li><strong>Ctrl+Alt+Q:</strong> Quit application</li>
          <li><strong>Ctrl+Alt+M:</strong> Toggle mouse interaction</li>
        </ul>
      </div>
    </div>
    
    <!-- Analysis Screen -->
    <div id="analysisScreen">
      <h2>Problem Analysis</h2>
      
      <img id="screenshotPreview" alt="Screenshot Preview">
      <div id="screenshotActions" style="display: none; margin-bottom: 15px;">
        <button id="analyzeScreenshotBtn" class="interactive">Analyze with AI</button>
        <button id="discardScreenshotBtn" class="interactive">Discard</button>
      </div>
      
      <div id="loadingAnalysis" class="loading hidden"></div>
      
      <div id="analysisResults" class="splitView hidden">
        <div class="leftPanel">
          <h3>Explanation</h3>
          <div id="explanationText"></div>
          <div id="complexityInfo"></div>
        </div>
        <div class="rightPanel">
          <h3>Code Solution</h3>
          <div class="code-container">
            <button id="copyCodeBtn" class="copy-btn interactive">Copy</button>
            <pre><code id="codeBlock"></code></pre>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Settings Screen -->
    <div id="settingsScreen">
      <h2>Settings</h2>
      
      <div class="setting-group">
        <label for="apiKeyInput">Gemini API Key:</label><br>
        <input type="password" id="apiKeyInput" class="interactive" placeholder="Enter your API key" style="width: 100%;">
      </div>
      
      <div class="setting-group">
        <label for="modelSelect">LLM Model:</label><br>
        <select id="modelSelect" class="interactive" style="width: 100%;">
          <option value="gemini-pro-vision">Gemini Pro Vision</option>
          <option value="gemini-1.5-pro-vision">Gemini 1.5 Pro Vision</option>
          <option value="gemini-1.5-flash-vision">Gemini 1.5 Flash Vision</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label for="languageSelect">Preferred Code Language:</label><br>
        <select id="languageSelect" class="interactive" style="width: 100%;">
          <option value="javascript">JavaScript</option>
          <option value="python">Python</option>
          <option value="java">Java</option>
          <option value="cpp">C++</option>
        </select>
      </div>
      
      <div class="setting-group">
        <label for="themeSelect">Editor Theme:</label><br>
        <select id="themeSelect" class="interactive" style="width: 100%;">
          <option value="vs-dark">Dark</option>
          <option value="github">Light</option>
        </select>
      </div>
      
      <button id="saveSettingsBtn" class="interactive">Save Settings</button>
      <div id="settingsSaved" style="color: #4CAF50; margin-top: 10px; display: none;">Settings saved successfully!</div>
    </div>
  </div>
  
  <div id="statusBar">
    <div>Status: <span id="statusText">Visible</span></div>
    <div id="modelInfo">Model: <span id="currentModel">Not set</span></div>
    <!-- <div id="mouseStatus">Mouse: <span id="mouseStatusText">Disabled</span></div> -->
  </div>

  <script>
    // Elements
    const tabs = document.querySelectorAll('.tab');
    const screens = document.querySelectorAll('#welcomeScreen, #analysisScreen, #settingsScreen');
    const statusText = document.getElementById('statusText');
    const mouseStatusText = document.getElementById('mouseStatusText');
    const currentModel = document.getElementById('currentModel');
    const screenshotPreview = document.getElementById('screenshotPreview');
    const screenshotActions = document.getElementById('screenshotActions');
    const loadingAnalysis = document.getElementById('loadingAnalysis');
    const analysisResults = document.getElementById('analysisResults');
    const explanationText = document.getElementById('explanationText');
    const codeBlock = document.getElementById('codeBlock');
    const complexityInfo = document.getElementById('complexityInfo');
    const copyCodeBtn = document.getElementById('copyCodeBtn');
    const interactionToggle = document.getElementById('interactionToggle');
    
    // Form elements
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelSelect = document.getElementById('modelSelect');
    const languageSelect = document.getElementById('languageSelect');
    const themeSelect = document.getElementById('themeSelect');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const settingsSaved = document.getElementById('settingsSaved');
    
    // Action buttons
    const captureScreenshotBtn = document.getElementById('captureScreenshotBtn');
    const analyzeScreenshotBtn = document.getElementById('analyzeScreenshotBtn');
    const discardScreenshotBtn = document.getElementById('discardScreenshotBtn');
    
    // Current state
    let settings = {
      apiKey: '',
      model: 'gemini-pro-vision',
      language: 'javascript',
      theme: 'vs-dark'
    };
    
    // Load settings from the file system on startup
    async function loadSetting() {
      try {
        const fileSettings = await window.electronAPI.loadSettings();
        settings = {
          apiKey: fileSettings.apiKey || '',
          model: fileSettings.model || 'gemini-pro-vision',
          language: fileSettings.language || 'javascript',
          theme: fileSettings.theme || 'vs-dark'
        };

        // Update the UI with the loaded settings
        apiKeyInput.value = settings.apiKey;
        modelSelect.value = settings.model;
        languageSelect.value = settings.language;
        themeSelect.value = settings.theme;
        currentModel.textContent = settings.model;

        console.log('Settings loaded successfully:', settings);
      } catch (error) {
        console.error('Failed to load settings from the file system:', error);

        // Use default settings if loading fails
        settings = {
          apiKey: '',
          model: 'gemini-pro-vision',
          language: 'javascript',
          theme: 'vs-dark'
        };

        // Update the UI with default settings
        apiKeyInput.value = settings.apiKey;
        modelSelect.value = settings.model;
        languageSelect.value = settings.language;
        themeSelect.value = settings.theme;
        currentModel.textContent = settings.model;
      }
    }

    // Save settings to the file system
    async function saveSetting() {
      settings = {
        apiKey: apiKeyInput.value,
        model: modelSelect.value,
        language: languageSelect.value,
        theme: themeSelect.value
      };

      try {
        const saved = await window.electronAPI.saveSettings(settings);
        if (saved) {
          console.log('Settings saved successfully:', settings);
          settingsSaved.style.display = 'block';
          currentModel.textContent = settings.model;
          setTimeout(() => {
            settingsSaved.style.display = 'none';
          }, 2000);
        } else {
          throw new Error('Failed to save settings');
        }
      } catch (error) {
        console.error('Failed to save settings:', error.message);
        alert(error.message);
      }
    }

    // Load settings on startup
    document.addEventListener('DOMContentLoaded', () => {
      loadSetting();
    });

    // Save settings when the "Save Settings" button is clicked
    saveSettingsBtn.addEventListener('click', saveSetting);
    
    // Mouse interaction state
    let mouseInteractionEnabled = false;
    
    // Function to enable mouse interaction
    function enableMouseInteraction() {
      if (!mouseInteractionEnabled) {
        window.electronAPI.toggleMouseEvents(false);
        mouseInteractionEnabled = true;
        document.body.classList.add('interaction-enabled');
        mouseStatusText.textContent = 'Enabled';
        interactionToggle.classList.add('mouse-active');
      }
    }
    
    // Function to disable mouse interaction
    function disableMouseInteraction() {
      if (mouseInteractionEnabled) {
        // Don't disable if we're focused on an input
        const activeElement = document.activeElement;
        if (activeElement.tagName === 'INPUT' || 
            activeElement.tagName === 'SELECT' || 
            activeElement.tagName === 'TEXTAREA') {
          return;
        }
        
        window.electronAPI.toggleMouseEvents(true);
        mouseInteractionEnabled = false;
        document.body.classList.remove('interaction-enabled');
        mouseStatusText.textContent = 'Disabled';
        interactionToggle.classList.remove('mouse-active');
      }
    }
    
    const debouncedDisableMouseInteraction = debounce(disableMouseInteraction, 200);
    
    // Function to toggle mouse interaction
    function toggleMouseInteraction() {
      if (mouseInteractionEnabled) {
        disableMouseInteraction();
      } else {
        enableMouseInteraction();
      }
    }
    
    // Add mouse toggle button functionality
    interactionToggle.addEventListener('click', (e) => {
      e.preventDefault();
      toggleMouseInteraction();
    });
    
    // Add global keyboard shortcut for toggling mouse interaction
    document.addEventListener('keydown', (e) => {
      // Ctrl+Alt+M
      if (e.ctrlKey && e.altKey && e.key === 'm') {
        toggleMouseInteraction();
      }
    });

    // Add global keyboard shortcut for toggling mouse interaction
    document.addEventListener('keydown', (e) => {
      // Ctrl+Shift+M
      if (e.ctrlKey && e.shiftKey && e.key === 'm') {
        toggleMouseInteraction();
      }
    });
    
    // Auto-enable mouse interaction when hovering over interactive elements
    const interactiveElements = document.querySelectorAll('.interactive');
    interactiveElements.forEach(element => {
      element.addEventListener('mouseenter', () => {
        enableMouseInteraction();
      });
    });
    
    // Handle focus events for form elements
    const formElements = document.querySelectorAll('input, select, textarea');
    formElements.forEach(element => {
      element.addEventListener('focus', () => {
        enableMouseInteraction();
      });
      
      element.addEventListener('blur', () => {
        // Don't disable immediately to allow clicking other elements
        // This will be handled by the document click handler
      });
    });
    
    // Disable mouse interaction when clicking outside interactive elements
    document.addEventListener('click', (e) => {
      let target = e.target;
      let isInteractiveElement = false;
      
      // Check if the click was on or inside an interactive element
      while (target && target !== document) {
        if (target.classList && (
            target.classList.contains('interactive') || 
            target.id === 'interactionToggle' ||
            target.tagName === 'INPUT' ||
            target.tagName === 'SELECT' ||
            target.tagName === 'TEXTAREA' ||
            target.tagName === 'BUTTON'
           )) {
          isInteractiveElement = true;
          break;
        }
        target = target.parentNode;
      }
      
      // If clicked outside interactive elements, disable mouse interaction
      if (!isInteractiveElement) {
        debouncedDisableMouseInteraction();
      }
    });
    
    // Tab navigation
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const targetScreen = tab.getAttribute('data-screen');
        screens.forEach(screen => {
          if (screen.id === targetScreen) {
            // Use flex display for analysis screen
            screen.style.display = screen.id === 'analysisScreen' ? 'flex' : 'block';
          } else {
            screen.style.display = 'none';
          }
        });
      });
    });
    
    // Listen for visibility change events from the main process
    window.electronAPI.onVisibilityChange((visible) => {
      statusText.textContent = visible ? 'Visible' : 'Hidden';
    });
    
    // Handle screenshot capture
    window.electronAPI.onScreenshotCaptured(async (imagePath) => {
      currentScreenshotPath = imagePath;
      
      try {
        // Convert the image file to data URL for display
        const dataUrl = await window.electronAPI.readImageAsDataURL(imagePath);
        screenshotPreview.src = dataUrl;
        screenshotPreview.style.display = 'block';
        screenshotActions.style.display = 'block';
        
        // Switch to the analysis tab
        tabs.forEach(t => t.classList.remove('active'));
        tabs[1].classList.add('active');
        screens.forEach(screen => screen.style.display = 'none');
        document.getElementById('analysisScreen').style.display = 'flex';
        
      } catch (error) {
        console.error('Failed to load screenshot:', error);
        alert(error.message || 'Failed to load screenshot2');
      }
    });
    
    captureScreenshotBtn.addEventListener('click', async () => {
      // Temporarily disable mouse events during the screenshot process
      const wasEnabled = mouseInteractionEnabled;
      disableMouseInteraction();
      await window.electronAPI.captureScreenshot();
      // Restore mouse interaction state if it was enabled before
      if (wasEnabled) {
        setTimeout(enableMouseInteraction, 500);
      }
    });
    
    analyzeScreenshotBtn.addEventListener('click', async () => {
      if (!currentScreenshotPath) {
        alert('No screenshot to analyze');
        return;
      }
      
      // Check if API key is set - First check localStorage, then settings object
      const apiKey = localStorage.getItem('apiKey') || settings.apiKey;
      if (!apiKey) {
        alert('Please set your API key in the Settings tab');
        return;
      }
      
      // Show loading state
      loadingAnalysis.classList.remove('hidden');
      analysisResults.classList.add('hidden');
      
      try {
        // Get language from localStorage or settings object
        const language = localStorage.getItem('language') || settings.language;
        const model = localStorage.getItem('model') || settings.model;
        
        // Construct prompt based on preferred language
        const prompt = `Preferred language: ${language}`;
        
        // Call the LLM API
        const result = await window.electronAPI.analyzeWithLLM(
          apiKey,
          model,
          currentScreenshotPath,
          prompt
        );
        
        // Display results
        explanationText.innerHTML = result.explanation;
        codeBlock.textContent = result.code;
        codeBlock.className = language;
        complexityInfo.textContent = result.complexity || "Time and Space Complexity not specified";
        
        // Apply syntax highlighting
        hljs.highlightElement(codeBlock);
        
        // Show results
        loadingAnalysis.classList.add('hidden');
        analysisResults.classList.remove('hidden');
        
      } catch (error) {
        console.error('Analysis failed:', error);
        alert(`Failed to analyze image: ${error.message || 'Unknown error'}`);
        loadingAnalysis.classList.add('hidden');
      }
    });
    
    // Copy code to clipboard
    copyCodeBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(codeBlock.textContent).then(() => {
        copyCodeBtn.textContent = "Copied!";
        setTimeout(() => {
          copyCodeBtn.textContent = "Copy";
        }, 2000);
      });
    });
    
    discardScreenshotBtn.addEventListener('click', () => {
      currentScreenshotPath = null;
      screenshotPreview.src = '';
      screenshotPreview.style.display = 'none';
      screenshotActions.style.display = 'none';
      analysisResults.classList.add('hidden');
    });
    
    // Initialize with mouse events disabled by default
    window.electronAPI.toggleMouseEvents(true);
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Briefly enable mouse interaction at startup to allow first interaction
      setTimeout(() => {
        enableMouseInteraction();
        setTimeout(disableMouseInteraction, 1000); 
      }, 500);
    });

    // Debounce function
    function debounce(func, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    }
  </script>
</body>
</html>
`